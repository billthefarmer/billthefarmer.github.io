<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<meta property="og:title" content="Create PDF Report" />
<meta property="og:description" content="Introduction As part of the Questionnaire Maker plugin it is necessary to create a pdf report. The best tool to do this appears to be TCPDF, which appears to be part of at least some Linux distributions as php-tcpdf. It is not included in WordPress.
Implementation As both the plugin and TCPDF are hosted on GitHub, the best way to implement the plugin, and TCPDF if it is not available on the web server, is to clone the repositories and use symbolic links to provide the plugin and the library in the right places." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://billthefarmer.github.io/blog/post/create-pdf-report/" />
<meta property="article:published_time" content="2018-09-18T19:27:46+01:00" />
<meta property="article:modified_time" content="2018-09-18T19:27:46+01:00" />

<meta itemprop="name" content="Create PDF Report">
<meta itemprop="description" content="Introduction As part of the Questionnaire Maker plugin it is necessary to create a pdf report. The best tool to do this appears to be TCPDF, which appears to be part of at least some Linux distributions as php-tcpdf. It is not included in WordPress.
Implementation As both the plugin and TCPDF are hosted on GitHub, the best way to implement the plugin, and TCPDF if it is not available on the web server, is to clone the repositories and use symbolic links to provide the plugin and the library in the right places.">
<meta itemprop="datePublished" content="2018-09-18T19:27:46&#43;01:00" />
<meta itemprop="dateModified" content="2018-09-18T19:27:46&#43;01:00" />
<meta itemprop="wordCount" content="856">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Create PDF Report"/>
<meta name="twitter:description" content="Introduction As part of the Questionnaire Maker plugin it is necessary to create a pdf report. The best tool to do this appears to be TCPDF, which appears to be part of at least some Linux distributions as php-tcpdf. It is not included in WordPress.
Implementation As both the plugin and TCPDF are hosted on GitHub, the best way to implement the plugin, and TCPDF if it is not available on the web server, is to clone the repositories and use symbolic links to provide the plugin and the library in the right places."/>






<meta name="generator" content="Hugo 0.64.0" />


    <base href="https://billthefarmer.github.io/blog/">
    <link rel="canonical" href="https://billthefarmer.github.io/blog/post/create-pdf-report/">
    <title>Create PDF Report | Bill Farmer</title>

    <!-- CSS -->
    <link href="https://billthefarmer.github.io/blog/css/app.css" rel="stylesheet">
    
    

    
    

<style>
.callout.large {
    background-image: url(https://billthefarmer.github.io/blog/images/2013/12/cropped-P1010089.jpg);
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
}
.callout.large a, .callout.large p {
    color: white;
}
pre {
    margin-top: 16px;
    margin-bottom: 16px;
}
code {
    padding: 0;
    border: 0;
    background-color: #fff;
    font-family: Consolas, "Liberation Mono", Courier, monospace;
    font-weight: normal;
    color: #0a0a0a;
}
</style>




  </head>
  <body>

    <header class="nav">
      <div class="top-bar">
        <div class="row column">
          <div class="top-bar-left">
          <div class="top-bar-right">
            <ul class="menu">
              
                
                  <li><a href="https://billthefarmer.github.io/blog/">
                    Bill Farmer
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/categories/">
                    Categories
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/categories/hacking/">
                    Hacking
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/categories/diy/">
                    DIY
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/categories/recipes/">
                    Recipes
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/categories/electronics/">
                    Electronics
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/index/">
                    Index
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/morris-o-meter/">
                    Morris-o-meter
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/about/">
                    About
                  </a></li>
                
                  <li><a href="https://billthefarmer.github.io/blog/test-o-meter/">
                    Test-o-meter
                  </a></li>
                
              
            </ul>
          </div>
        </div>
      </div>
    </header>

    <header class="blog-header">
      <div class="callout large">
        <div class="row column text-center">
          <h1>
            <a href="https://billthefarmer.github.io/blog/" rel="home">Bill Farmer</a>
          </h1>
          
            <p>
              Random thoughts on random subjects
            </p>
          
        </div>
      </div>
    </header>

    <main>
      <div class="row" id="content">
        <div class="medium-8 columns">
          
  


  <div class="blog-post">
    <h3>
      <a href="https://billthefarmer.github.io/blog/post/create-pdf-report/">Create PDF Report</a>
    </h3>
    <div class="callout small">
      <small>
        <time datetime="2018-09-18T19:27:46&#43;01:00">
          Tue Sep 18, 2018
        </time> by Bill Farmer.
        Categories: 
  
    
      <a href="/blog/categories/hacking">
        Hacking
      </a>
  

.
        
        <br>
        
      </small>
    </div>
    <p>
      <h3 id="introduction">Introduction</h3>
<p>As part of the <a href="https://billthefarmer.github.io/blog/post/questionnaire">Questionnaire Maker</a> plugin it is necessary to
create a pdf report. The best tool to do this appears to be
<a href="https://tcpdf.org">TCPDF</a>, which appears to be part of at least some Linux
distributions as <code>php-tcpdf</code>. It is not included in WordPress.</p>
<h3 id="implementation">Implementation</h3>
<p>As both the plugin and TCPDF are hosted on GitHub, the best way to
implement the plugin, and TCPDF if it is not available on the web
server, is to clone the repositories and use symbolic links to provide
the plugin and the library in the right places. The same method could
be used to implement WordPress.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">user@server:~ $ git clone https://github.com/billthefarmer/questionnaire.git
user@server:~ $ <span style="color:#a2f">cd</span> /var/www/html/wordpress/wp-content/plugins/
user@server:/var/www/html/wordpress/wp-content/plugins $ ln -s ~/questionnaire/wordpress questionnaire_maker
user@server:/var/www/html/wordpress/wp-content/plugins $ <span style="color:#a2f">cd</span> ~
user@server:~ $ git clone https://github.com/tecnickcom/TCPDF.git tcpdf
user@server:~ $ <span style="color:#a2f">cd</span> questionnaire/wordpress
user@server:~/questionnaire/wordpress $ ln -s ~/tcpdf
</code></pre></div><p>The plugin includes code to load TCPDF if it is present and show a
message if it isn&rsquo;t. Using the path <code>tcpdf/tcpdf.php</code> will pick it up
either from <code>/usr/share/php</code>, if installed, or from the symbolic link.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">// Include TCPDF, if present
$tcpdf_present = include_once &#39;tcpdf/tcpdf.php&#39;;
</code></pre></div><p>After more work on this project I needed another library which makes
use of <a href="https://getcomposer.org">composer</a> for dependencies. TCPDF doesn&rsquo;t have any, but you
can create a <code>composer.json</code> in the plugin and load TCPDF.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">user@server:~/questionnaire/wordpress $ php composer.phar require tecnickcom/tcpdf
</code></pre></div><p>Using composer, the code to load libraries changes to pick them up
from the vendor folder.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">// Include composer libraries, if present
$vendor_present = include_once &#39;vendor/autoload.php&#39;
</code></pre></div><h3 id="displaying-errors">Displaying errors</h3>
<p>To avoid the dreaded WordPress White Screen of Death (WSOD), you can
temporarily put a couple of lines at the top of the plugin to display
PHP errors.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">error_reporting(E_ALL);
ini_set(&#39;display_errors&#39;, 1);
</code></pre></div><h3 id="creating-the-document">Creating the document</h3>
<p>The code to create a pdf document is fairly straightforward. The
examples given always seem to specify everything, but by making note
of the defaults, that isn&rsquo;t necessary.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">        // Create document
        $pdf = new TCPDF();
        $pdf-&gt;setPageUnit(&#39;pt&#39;);

        // Remove default header/footer
        $pdf-&gt;setPrintHeader(false);
        $pdf-&gt;setPrintFooter(false);

        $margin = 72; // 1&#34;
        $pageWidth = $pdf-&gt;getPageWidth();
        $pageHeight = $pdf-&gt;getPageHeight();
        $textWidth = $pageWidth - ($margin * 2);

        // Set margins
        $pdf-&gt;SetMargins($margin, $margin, $margin);
        $pdf-&gt;SetAutoPageBreak(true, $margin);
</code></pre></div><p>TCPDF doesn&rsquo;t seem to include a function to move the insertion point
down a line, you need to nest three functions to get the right result.
The functions to add text make use of the <code>MultiCell()</code> function. Also
the <code>SetFont()</code> function is used to set the font type.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">        // New line
        function new_text_line($pdf)
        {
            $pdf-&gt;Ln($pdf-&gt;getCellHeight($pdf-&gt;getFontSize()));
        };

        // Add text
        function add_text_object($pdf, $text, $forename = &#39;&#39;, $lastname = &#39;&#39;)
        {
            if (!empty($text-&gt;type))
                $pdf-&gt;SetFont(&#39;&#39;, $text-&gt;type);

            else
                $pdf-&gt;SetFont(&#39;&#39;, &#39;&#39;);

            if (!empty($text-&gt;size))
                $pdf-&gt;SetFontSize($text-&gt;size);

            if (!empty($text-&gt;color))
                $pdf-&gt;SetTextColor($text-&gt;color);

            if (!empty($text-&gt;y))
                $pdf-&gt;SetY($text-&gt;y);

            $subst = str_replace([&#39;~forename~&#39;, &#39;~lastname~&#39;],
                                      [$forename, $lastname], $text-&gt;text);

            $pdf-&gt;MultiCell(0, 0, $subst, 0, &#39;L&#39;);
        };

        // Add report entry
        function add_entry($pdf, $entry, $value)
        {
            $desc = $entry-&gt;desc;
            $type = $entry-&gt;$value-&gt;type;
            $text = $entry-&gt;$value-&gt;text;
            $image = $entry-&gt;$value-&gt;image;

            $y = $pdf-&gt;GetY();
            $pdf-&gt;Image($path . $image, $margin, $y, $textWidth, 0,
                        &#39;png&#39;, &#39;&#39;, &#39;N&#39;);

            $pdf-&gt;MultiCell(0, 0, $desc, 0, &#39;L&#39;);
            new_text_line($pdf);
            $pdf-&gt;SetFont(&#39;&#39;, &#39;B&#39;);
            $pdf-&gt;MultiCell(0, 0, $type, 0, &#39;L&#39;);
            new_text_line($pdf);
            $pdf-&gt;SetFont(&#39;&#39;, &#39;&#39;);
            $pdf-&gt;MultiCell(0, 0, $text, 0, &#39;L&#39;);
            new_text_line($pdf);
        };
</code></pre></div><p>To display images requires a set of rules to place the image on the
page. If the width is empty or zero, text width, else width. If the
height is empty or zero, height in proportion to width, else
height. If x is empty or zero, left margin, if negative, right margin,
else x. If y is empty or zero, top margin, negative, bottom margin,
else y.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">        // Add image
        function add_image_object($pdf, $image, $margin, $textWidth,
                                  $pageHeight, $pageWidth, $path)
        {
            $width = (!empty($image-&gt;width))? $image-&gt;width: $textWidth;
            $height = (!empty($image-&gt;height))? $image-&gt;height: 0;
            $x = (!empty($image-&gt;x))? ($image-&gt;x &lt; <span style="color:#008000;font-weight:bold">0</span><span style="">)</span><span style="">?</span>
               <span style="">$</span><span style="color:#b44">pageWidth</span> <span style="color:#b44">-</span> <span style="">$</span><span style="color:#b44">margin</span> <span style="color:#b44">-</span> <span style="">$</span><span style="color:#b44">width:</span> <span style="">$</span><span style="color:#b44">image-</span>&gt;x: $margin;
            $y = (!empty($image-&gt;y))? ($image-&gt;y &lt; <span style="color:#008000;font-weight:bold">0</span><span style="">)</span><span style="">?</span>
               <span style="">$</span><span style="color:#b44">pageHeight</span> <span style="color:#b44">-</span> <span style="">$</span><span style="color:#b44">margin</span> <span style="color:#b44">-</span> <span style="">$</span><span style="color:#b44">height:</span> <span style="">$</span><span style="color:#b44">image-</span>&gt;y: $margin;
            $type = (!empty($image-&gt;type))? $image-&gt;type: &#39;&#39;;
            $link = (!empty($image-&gt;link))? $image-&gt;link: &#39;&#39;;
            $pdf-&gt;Image($path . $image-&gt;src, $x, $y, $width, $height,
                        $type, $link);
        };
</code></pre></div><p>The report starts with a preamble.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
        // Preamble
        foreach ($pages as $page)
        {            
            $pdf-&gt;AddPage();

            // Text
            foreach ($page-&gt;text as $text)
                add_text_object($pdf, $text, $forename, $lastname);

            // Images
            foreach ($page-&gt;images as $image)
                add_image_object($pdf, $image, $margin, $textWidth,
                                 $pageHeight, $pageWidth, $path);
        }
</code></pre></div><p>Then the report body. Because each section starts with an image, start
a new page if near the bottom.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
        // Report
        $pdf-&gt;AddPage();

        if ($B)
            add_entry($pdf, $answers-&gt;B, $B, $margin, $textWidth, $path);

        if ($C)
            add_entry($pdf, $answers-&gt;C, $C, $margin, $textWidth, $path);

        if ($pdf-&gt;GetY() &gt;= $pageHeight - ($margin * 3))
            $pdf-&gt;AddPage();
    // ...
</code></pre></div><p>Then the last page.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
        $pdf-&gt;AddPage();

        // Last page text
        foreach ($last-&gt;text as $text)
            add_text_object($pdf, $text);

        // Last page images
        foreach ($last-&gt;images as $image)
            add_image_object($pdf, $image, $margin, $textWidth,
                             $pageHeight, $pageWidth, $path);
</code></pre></div><p>Output the document, and return the path to it.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
        // Output document
        $pdf-&gt;Output($path . &#39;report/&#39; . $filename, &#39;F&#39;);

        // Return file uri
        return plugins_url(&#39;report/&#39; . $filename, __FILE__);
</code></pre></div><h3 id="creating-an-email">Creating an email</h3>
<p>To send the report, create an email and send it.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">        // Set fields
        $to = &#34;$username <span style="">&lt;</span>$usermail&gt;&#34;;
        $from_email = $data-&gt;from_email;
        $from_name = $data-&gt;from_name;
        $from = &#34;$from_name <span style="">&lt;</span>$from_email&gt;&#34;;
        $subject = str_replace(&#39;~forename~&#39;, $forename, $data-&gt;subject);
        $message = str_replace(&#39;~forename~&#39;, $forename, $data-&gt;message);
        $content = &#34;Content-Type: text/html&#34;;
        $headers = [&#34;From: $from&#34;,
                    $content];

        // Get attachment path
        $path = plugin_dir_path(__FILE__);
        $attachments = $path . &#34;report/&#34; . $filename;

        // Send mail
        wp_mail($to, $subject, $message, $headers,
                $attachments);
</code></pre></div>
    </p>
    
    

<hr>
<h3>See Also</h3>
<ul>
  
  <li><a href="/blog/post/questionnaire/">Questionnaire Maker</a></li>
  
  <li><a href="/blog/whatever-o-meter-revisited/">Whatever-o-meter revisited</a></li>
  
  <li><a href="/blog/whatever-o-meter/">Whatever-o-meter</a></li>
  
  <li><a href="/blog/migrating-blog-from-wordpress/">Migrating this blog from Wordpress</a></li>
  
  <li><a href="/blog/slimstat/">SlimStat</a></li>
  
</ul>


      <hr>
  </div>

  


        </div>
          <div class="medium-3 columns" data-sticky-container>
  <div class="sticky" data-sticky data-anchor="content">

  

  

  <h4>Recent Posts</h4>
  <ul>
    
      <li><a href="/blog/hiding-button/">
        Hiding Edit Button
      </a></li>
    
      <li><a href="/blog/derive-edit-position/">
        Derive Edit Position from Markdown
      </a></li>
    
      <li><a href="/blog/fixing-basin-waste-pop-up/">
        Fixing Basin Waste Pop Up
      </a></li>
    
      <li><a href="/blog/pi-hole-cloudflare-setup/">
        Pi-hole Cloudflare, DNSCrypt, Unbound Setup
      </a></li>
    
      <li><a href="/blog/post/mushrooms-and-soy-sauce/">
        Mushrooms and Soy Sauce
      </a></li>
    
      <li><a href="/blog/post/source-code-highlighting/">
        Source Code Syntax Highlighting
      </a></li>
    
      <li><a href="/blog/post/musical-temperaments/">
        Musical Temperaments
      </a></li>
    
      <li><a href="/blog/post/draw-musical-staff/">
        Draw Musical Staff
      </a></li>
    
      <li><a href="/blog/post/expand-android-selection/">
        Expand Android Selection
      </a></li>
    
      <li><a href="/blog/interesting-mash/">
        Interesting Mash
      </a></li>
    
  </ul>

  
    <h4>Links</h4>
    <ul>
      
        <li><a href="https://github.com/billthefarmer">
          Github
        </a></li>
      
        <li><a href="https://gitlab.com/williamjfarmer">
          Gitlab
        </a></li>
      
        <li><a href="http://billthefarmer.github.io">
          Home
        </a></li>
      
    </ul>
  

  </div>
</div>

      </div>
    </main>

    <footer class="blog-footer">
      <div class="row column">
        <p>
          
          Copyright © 2019 Bill Farmer
          
        </p>
        <p>
          <a href="https://billthefarmer.github.io/blog/post/create-pdf-report/#">Back to top</a>
        </p>
      </div>
    </footer>

  <foot>

    <script src="https://billthefarmer.github.io/blog/js/app.js"></script>

  </foot>
  </body>
</html>
